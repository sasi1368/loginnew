
const username=localStorage.getItem("username"),name=localStorage.getItem("name");if(!username||!name){alert("لطفاً ابتدا وارد شوید.");window.location.href="login.html"}else{document.getElementById("welcome").innerText=`خوش آمدی ${name}`}function toggleDarkMode(){document.body.classList.toggle("dark-mode")}function logout(){localStorage.removeItem("username"),localStorage.removeItem("name"),window.location.href="login.html"}async function submitPatient(){const patientName=document.getElementById("patientName").value,patientPhone=document.getElementById("patientPhone").value;if(!patientName||!patientPhone)return alert("لطفاً نام و شماره تماس را وارد کنید.");const code=`pt-${Math.floor(100000+Math.random()*900000)}`;try{const res=await fetch("/api/patients",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:patientName,phone:patientPhone,code,username})});const data=await res.json();if(data.success){sendToTelegram(patientName,patientPhone,code),document.getElementById("qrcode").innerHTML="",new QRCode(document.getElementById("qrcode"),code),document.getElementById("patientCode").innerText=`کد بیمار: ${code}`,updateStats(),loadPatientLists()}else{alert(data.message||"خطا در ثبت بیمار")}}catch(err){console.error(err),alert("خطا در اتصال به سرور")}}async function sendToTelegram(patientName,patientPhone,code){const message=`\n        بیمار جدید ثبت‌شده:\n        نام: ${patientName}\n        شماره تماس: ${patientPhone}\n        کد بیمار: ${code}\n      `;try{await fetch('https://api.telegram.org/botYOUR_BOT_TOKEN/sendMessage',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id:'YOUR_CHAT_ID',text:message})})}catch(err){console.error("خطا در ارسال به تلگرام:",err)}}async function updateStats(){try{const res=await fetch("/api/patients/stats");const data=await res.json();document.getElementById("realVisits").innerText=`تعداد مراجعه واقعی: ${data.visited}`}catch{document.getElementById("realVisits").innerText="جهت بروزرسانی صفحه را رفرش کنید"}}async function loadPatientLists(){try{const res=await fetch(`/api/patients/list?username=${username}`);const data=await res.json(),submitted=document.getElementById("submittedPatients"),approved=document.getElementById("approvedPatients");submitted.innerHTML="",approved.innerHTML="",data.forEach(p=>{const html=`\n            <div class="list-item">\n              ${p.name} - ${p.phone} - ${p.code}\n              ${p.approved?"<span>تایید شده</span>":""}\n            </div>`;p.approved?approved.innerHTML+=html:submitted.innerHTML+=html})}catch{document.getElementById("submittedPatients").innerText="خطا در بارگذاری",document.getElementById("approvedPatients").innerText="خطا در بارگذاری"}}async function approvePatient(patientId){try{const res=await fetch(`/api/patients/approve/${patientId}`,{method:"POST"});const data=await res.json();if(data.success){await fetch(`/api/patients/transferToVisited/${patientId}`,{method:"POST"}),loadPatientLists()}else{alert("خطا در تایید بیمار")}}catch(err){console.error("خطا در تایید بیمار:",err)}}updateStats(),loadPatientLists();
